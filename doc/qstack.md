# qstack

## スタック構造

### フレーム

フレームは手続きの呼び出しごとに作成されるスタック上の領域です。
フレームには以下の４つの領域があります。
 
- 評価領域<br>
  スタックの先頭に位置する領域で、式の評価を行うために使用します。
- ローカル変数領<br>
  評価領域の次に位置する領域で、ローカル変数を格納します。
- 旧フレームポインタ<br>
  ひとつ前のフレームポインタを格納する領域です。
  現在のフレームポインタはこの位置を指しています。
- 引数領域<br>
  手続きに渡された引数を格納する領域です。

![フレーム](qstack-フレーム.drawio.svg)

各領域には以下のようにワードでアクセスできます。
L1, L2はローカル変数の参照で、S1, S2はローカル変数への格納です。
A1, A2は引数の参照です。
引数はスタックに積んだ順序とは逆の番号でアクセスする点に注意します。
これはフレームポインタ(fp)の相対位置でアクセスするためです。
L1のアドレスはstack[fp + 2]です。
A1のアドレスはstack[fp - 1]です。


![引数とローカル変数](qstack-引数とローカル変数.drawio.svg)

実装上は

## 名前付きフレーム

書式:

(F r A<sub>n</sub> ... A<sub>2</sub> A<sub>1</sub> : W<sub>1</sub> W<sub>2</sub> ... )

- F : 名前付きフレームマーカー
- r : 戻り値の数
- A<sub>n</sub> : 仮引数名
- W<sub>m</sub> : ワード

階乗を計算する再帰的名前付きフレームは以下のようになる。

```
'(F 1 n : n 0 <= 1 '(n 1 - self n *) if)
```


## 名前付きフレーム2

書式:

(frame r (A<sub>n</sub> ... A<sub>2</sub> A<sub>1</sub> [: L<sub>1</sub> L<sub>2</sub> ...]) W<sub>1</sub> W<sub>2</sub> ... )

- F : 名前付きフレームマーカー
- r : 戻り値の数
- A<sub>n</sub> : 仮引数名
- L<sub>n</sub> : ローカル変数名
- W<sub>m</sub> : ワード

階乗を計算する再帰的名前付きフレームは以下のようになる。

```
'(frame 1 (n) n 0 <= 1 '(n 1 - self n *) if)
```

## 配列

配列の作成

```
n Array
```

配列aのサイズを取り出す。

```
a size
```

配列aのi番目の要素を取り出す。

```
a i at
```


配列aのi番目の要素としてeをセットする

```
a i e put
```


## モデル

![クラス図](qstack-クラス図.drawio.svg)